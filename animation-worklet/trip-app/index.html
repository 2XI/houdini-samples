<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Trip app</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <nav>
    <ul>
      <li><a href="#list">List Page</a></li>
      <li><a href="#info">Info Page</a></li>
    </ul>
  </nav>
  <section id="list">
    <ul>
      <li>
        <div class="row_container">
          <div class="icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3zm-4.4 15.55l-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z"/></svg>
          </div>
          <div class="row">
            <div class="entry_container">
              <div class="entry"> Brazil, Swipe me right ==></div>
          </div>
        </div>
      </li>
      <li>
        <div class="row_container">
          <div class="icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3zm-4.4 15.55l-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z"/></svg>
          </div>
          <div class="row">
            <div class="entry_container">
              <div class="entry"> Mexico,  Swipe me right ==></div>
          </div>
        </div>
      </li>
      <li>
        <div class="row_container">
          <div class="icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3zm-4.4 15.55l-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z"/></svg>
          </div>
          <div class="row">
            <div class="entry_container">
              <div class="entry"> Canada, Swipe me right ==></div>
          </div>
        </div>
      </li>
      <li>
        <div class="row_container">
          <div class="icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3zm-4.4 15.55l-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z"/></svg>
          </div>
          <div class="row">
            <div class="entry_container">
              <div class="entry"> United States, Swipe me right ==></div>
          </div>
        </div>
      </li>
      <li>
        <div class="row_container">
          <div class="icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3zm-4.4 15.55l-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z"/></svg>
          </div>
          <div class="row">
            <div class="entry_container">
              <div class="entry"> Costa Rica, Swipe me right ==></div>
          </div>
        </div>
      </li>
     </ul>
  </section>

  <section id="info">
    <div id="chips">
      <div id="indicator"></div>
      <ul class="">
        <li> 1
        <li> 2
        <li> 3
        <li> 4
        <li> 5
        <li> 6
      </ul>
    </div>

    <div id="images">
      <div id="images_container">
        <figure class="figure">
          <img src="http://source.unsplash.com/JMYBetGDIKY">
        </figure>
        <figure class="figure">
          <img src="http://source.unsplash.com/AJgFLjnmSs4">
        </figure>
        <figure class="figure">
          <img src="http://source.unsplash.com/JMYBetGDIKY">
        </figure>
        <figure class="figure">
          <img src="http://source.unsplash.com/JMYBetGDIKY">
        </figure>
        <figure class="figure">
          <img src="http://source.unsplash.com/AJgFLjnmSs4">
        </figure>
        <figure class="figure">
          <img src="http://source.unsplash.com/JMYBetGDIKY">
        </figure>
        <figure class="figure">
          <img src="http://source.unsplash.com/AJgFLjnmSs4">
        </figure>
      </div>
    </div>

    <div id="tabs">
      <ul class="horizontal">
        <li> <p>Brazil</p>
        <li> <p>Mexico</p>
        <li> <p>Canada</p>
        <li> <p>United States</p>
        <li> <p>Costa Rica</p>
        <li style="margin-right: 0;"> <p>Argentina</p>
      </ul>
    </div>
  </section>

</body>

<script>
  // redirect to https since AnimationWorklet is only availably in secure contexts.
  if (location.hostname != 'localhost' && location.protocol != 'https:') {
    location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
  }

  // A simple router.
  function gotoPage() {
    var pageName = '#list';
    if (location.hash.trim().length != 0)
      pageName = location.hash.trim();

    const page = document.body.querySelector(`section${pageName}`);
    if (!page)
      return;
    // hide all except the page of interest
    document.body.querySelectorAll('section').forEach(s => { s.style.display = 'none'; });
    page.style.display = '';
    if (pageName == '#info')
      loadInfoPageAnimations();
    else
      loadListPageAnimations();
  }
  window.addEventListener('hashchange', gotoPage);


  // Load Animations
  (async function () {
    if (!CSS.animationWorklet) {
      console.warn('Missing CSS.animationWorklet. To enable scroll effect please load in HTTPS and enable flag chrome://flags/#enable-experimental-web-platform-features');
      document.body.innerHTML = 'Missing <tt>CSS.animationWorklet</tt>. <br/> To enable demo please enable Chrome flag chrome://flags/#enable-experimental-web-platform-features and load on HTTPS'
      return;
    }
    console.log('Loading animation worklet');
    await CSS.animationWorklet.addModule('swipe-animator.js');
    gotoPage();

  })();

  function loadListPageAnimations() {
    const list = document.getElementById('list');
    const rows = list.querySelectorAll('.row_container');
    for (let i = 0; i < rows.length ; i++ ) {
      createRowAnimations(rows[i]);
    }

  }

  function createRowAnimations(row_container) {
    const row = row_container.querySelector('.row');
    const icon = row_container.querySelector('.icon');
    const entry = row.querySelector('.entry');
    row.scrollTo(1, 0);

    const scrollRange = row.scrollWidth - row.clientWidth;
    const scrollTimeline = new ScrollTimeline({ scrollSource: row, orientation: 'inline', timeRange: scrollRange });

    const iconWidth = icon.clientWidth;
    const iconLeft = icon.offsetLeft;
    const iconTop = icon.offsetTop;

    const threshold = entry.clientWidth * 0.4;
    const options = {
      start: entry.offsetLeft,
      width: threshold,
    };

    const scale_effect = new KeyframeEffect(
      icon.querySelector('svg'),
      { transform: ['scale(0.5)', 'scale(1)'],
        opacity: [0, 1]
      },
      { duration: 50, delay: 50, iterations: 1, fill: 'both' ,  easing:'linear'});

    const scale_options = {
      ...options,
      play_when_favorited: false,
    };

    const transform_effect = new KeyframeEffect(
      icon,
      {
        transform: [`translate(-${iconLeft}px, -${iconTop}px) scale(1)`, 'translate(0,0) scale(1)'],
      },
      { duration: 100, iterations: 1, easing:'linear' });

    const transform_options = {
      ...options,
      play_when_favorited: true,
    };

    new WorkletAnimation('icon_effect', scale_effect, scrollTimeline, scale_options).play();
    new WorkletAnimation('icon_effect', transform_effect, scrollTimeline, transform_options).play();

  }

  function loadInfoPageAnimations() {

    const tabs = document.getElementById('tabs');
    const scrollRange = tabs.scrollWidth - tabs.clientWidth;
    const scrollTimeline = new ScrollTimeline({
      scrollSource: tabs, orientation: 'inline',
      timeRange: scrollRange
    });

    createImageAnimations(scrollTimeline);
    createIndicatorAnimation(scrollTimeline);

  }
  function createImageAnimations(scrollTimeline) {
    const image_container = document.getElementById('images');

    // FIXME: I am a layout noob!
    // somehow the container size is the same size as one image
    const width = (2 * 5) * image_container.clientWidth;
    const container = new KeyframeEffect(
      image_container,
      { transform: ['translateX(0)', 'translateX(-' + width + 'px)'] },
      { duration: scrollTimeline.timeRange, iterations: 1, fill: "both" });

    new WorkletAnimation('passthrough', container, scrollTimeline).play();

    // TODO: Create scale and counter-scale animations for each image
  }

  function createTabAnimation(scrollTimeline, tab, content) {
    const effect = new KeyframeEffect(content,
      {
        opacity: [1, 0],
        transform: ['scale3d(1, 1, 1)', 'scale3d(0.9, 0.9, 1)']
      },
      { duration: 100, iterations: 1, fill: "both" });
    // Pass offset left as an option but once we support start and end
    // scroll offset in ScrollTimeline we can get rid of this.
    const animation = new WorkletAnimation(
      'material_tab_swipe', effect, scrollTimeline,
      { offset: tab.offsetLeft, width: tab.clientWidth });
    animation.play();
  }

  function createIndicatorAnimation(scrollTimeline, scrollRange) {
    const chip_container = document.querySelector('#info #chips');
    const chips = chip_container.querySelectorAll('li');
    const indicator = document.querySelector('#indicator');
    const width = chips[chips.length-1].offsetLeft - chips[0].offsetLeft;
    const indicator_effect = new KeyframeEffect(indicator,
      { transform: ['translateX(0px)', 'translateX(' + width + 'px)'] },
      { duration: scrollTimeline.timeRange, iterations: 1, fill: "both" });
    const chip_animation = new WorkletAnimation(
      'passthrough', indicator_effect, scrollTimeline);
    chip_animation.play();
  }
</script>

</html>